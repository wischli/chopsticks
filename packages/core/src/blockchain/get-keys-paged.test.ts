import { Api } from '../api.js'
import { RemoteStorageLayer, StorageLayer, StorageValueKind } from './storage-layer.js'
import { describe, expect, it, vi } from 'vitest'
import _ from 'lodash'

describe('getKeysPaged', () => {
  const hash = '0x1111111111111111111111111111111111111111111111111111111111111111'

  const allKeys = [
    '0x0000000000000000000000000000000000000000000000000000000000000000_00',
    '0x0000000000000000000000000000000000000000000000000000000000000000_03',
    '0x0000000000000000000000000000000000000000000000000000000000000000_04',
    '0x1111111111111111111111111111111111111111111111111111111111111111_01',
    '0x1111111111111111111111111111111111111111111111111111111111111111_02',
    '0x1111111111111111111111111111111111111111111111111111111111111111_03',
    '0x1111111111111111111111111111111111111111111111111111111111111111_06',
    '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    '0x2222222222222222222222222222222222222222222222222222222222222222_21',
    '0x2222222222222222222222222222222222222222222222222222222222222222_23',
    '0x2222222222222222222222222222222222222222222222222222222222222222_26',
    '0x94533e05c34400caee0d8976774f0dd064443ba500633e46053c7a0a68b8ef3392a72b59fc8b67b702000001a12dfa1fa4ab9a0000',
  ]

  Api.prototype['getKeysPaged'] = vi.fn(async (prefix, pageSize, startKey) => {
    const withPrefix = allKeys.filter((k) => k.startsWith(prefix) && k > startKey)
    const result = withPrefix.slice(0, pageSize)
    return result
  })
  const mockApi = new Api(undefined!)

  const remoteLayer = new RemoteStorageLayer(mockApi, hash, undefined)
  const storageLayer = new StorageLayer(remoteLayer)

  it('mocked api works', async () => {
    expect(
      await mockApi.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        1,
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        hash,
      ),
    ).toEqual(['0x1111111111111111111111111111111111111111111111111111111111111111_01'])

    expect(
      await mockApi.getKeysPaged(
        '0x2222222222222222222222222222222222222222222222222222222222222222',
        4,
        '0x2222222222222222222222222222222222222222222222222222222222222222',
        hash,
      ),
    ).toEqual([
      '0x2222222222222222222222222222222222222222222222222222222222222222_21',
      '0x2222222222222222222222222222222222222222222222222222222222222222_23',
      '0x2222222222222222222222222222222222222222222222222222222222222222_26',
    ])

    expect(
      await mockApi.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_02',
        hash,
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_03',
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])

    expect(
      await mockApi.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        2,
        '0x1111111111111111111111111111111111111111111111111111111111111111_04',
        hash,
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])

    expect(
      await mockApi.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        2,
        '0x1111111111111111111111111111111111111111111111111111111111111111_07',
        hash,
      ),
    ).toEqual([])
  })

  it('remote layer works', async () => {
    expect(
      await remoteLayer.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        3,
        '0x1111111111111111111111111111111111111111111111111111111111111111',
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_01',
      '0x1111111111111111111111111111111111111111111111111111111111111111_02',
      '0x1111111111111111111111111111111111111111111111111111111111111111_03',
    ])

    expect(
      await remoteLayer.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_03',
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])
  })

  it('storage layer works', async () => {
    expect(
      await mockApi.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        1,
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        hash,
      ),
    ).toEqual(['0x1111111111111111111111111111111111111111111111111111111111111111_01'])

    expect(
      await mockApi.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_02',
        hash,
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_03',
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])
  })

  it('updated values', async () => {
    const layer2 = new StorageLayer(storageLayer)
    layer2.setAll([
      ['0x1111111111111111111111111111111111111111111111111111111111111111_00', '0x00'],
      ['0x1111111111111111111111111111111111111111111111111111111111111111_04', '0x04'],
    ])
    expect(
      await layer2.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_03',
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_04',
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])

    expect(
      await layer2.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111',
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_00',
      '0x1111111111111111111111111111111111111111111111111111111111111111_01',
      '0x1111111111111111111111111111111111111111111111111111111111111111_02',
      '0x1111111111111111111111111111111111111111111111111111111111111111_03',
      '0x1111111111111111111111111111111111111111111111111111111111111111_04',
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])

    expect(
      await layer2.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_04',
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])

    expect(
      await layer2.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_07',
      ),
    ).toEqual([])

    const layer3 = new StorageLayer(layer2)
    layer3.setAll([
      ['0x1111111111111111111111111111111111111111111111111111111111111111_03', '0x03'],
      ['0x1111111111111111111111111111111111111111111111111111111111111111_04', null],
      ['0x1111111111111111111111111111111111111111111111111111111111111111_06', '0x06'],
    ])

    expect(
      await layer3.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_02',
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_03',
      '0x1111111111111111111111111111111111111111111111111111111111111111_06',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
    ])

    const layer4 = new StorageLayer(layer3)
    layer4.setAll([
      ['0x1111111111111111111111111111111111111111111111111111111111111111_03', null],
      ['0x1111111111111111111111111111111111111111111111111111111111111111_04', '0x04'],
      ['0x1111111111111111111111111111111111111111111111111111111111111111_06', null],
      ['0x1111111111111111111111111111111111111111111111111111111111111111_08', '0x08'],
    ])

    expect(
      await layer4.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111_02',
      ),
    ).toEqual([
      '0x1111111111111111111111111111111111111111111111111111111111111111_04',
      '0x1111111111111111111111111111111111111111111111111111111111111111_07',
      '0x1111111111111111111111111111111111111111111111111111111111111111_08',
    ])

    const layer5 = new StorageLayer(layer4)
    layer5.setAll([
      ['0x1111111111111111111111111111111111111111111111111111111111111111', StorageValueKind.DeletedPrefix],
      ['0x1111111111111111111111111111111111111111111111111111111111111111_09', '0x09'],
    ])
    expect(
      await layer5.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111',
      ),
    ).toEqual(['0x1111111111111111111111111111111111111111111111111111111111111111_09'])

    const layer6 = new StorageLayer(layer5)
    layer6.setAll([
      ['0x1111111111111111111111111111111111111111111111111111111111111111', StorageValueKind.DeletedPrefix],
    ])
    expect(
      await layer6.getKeysPaged(
        '0x1111111111111111111111111111111111111111111111111111111111111111',
        10,
        '0x1111111111111111111111111111111111111111111111111111111111111111',
      ),
    ).toEqual([])

    layer6.setAll([
      [
        '0x94533e05c34400caee0d8976774f0dd064443ba500633e46053c7a0a68b8ef3392a72b59fc8b67b7020000e8d2a526a4a22d1e0300000000',
        '0x01',
      ],
      [
        '0x99971b5749ac43e0235e41b0d37869188ee7418a6531173d60d1f6a82d8f4d5143ce24f679759c60d1cd42f70aeae77f6d6f646c6163612f636470740000000000000000000000000000000000000000d67c5ba80ba065480001',
        '0x01',
      ],
    ])

    expect(
      await layer6.getKeysPaged(
        '0x94533e05c34400caee0d8976774f0dd064443ba500633e46053c7a0a68b8ef3392a72b59fc8b67b7020000',
        10,
        '0x94533e05c34400caee0d8976774f0dd064443ba500633e46053c7a0a68b8ef3392a72b59fc8b67b7020000',
      ),
    ).toEqual([
      '0x94533e05c34400caee0d8976774f0dd064443ba500633e46053c7a0a68b8ef3392a72b59fc8b67b702000001a12dfa1fa4ab9a0000',
      '0x94533e05c34400caee0d8976774f0dd064443ba500633e46053c7a0a68b8ef3392a72b59fc8b67b7020000e8d2a526a4a22d1e0300000000',
    ])
  })

  it('firstKey is checked properly', async () => {
    const layer2 = new StorageLayer(storageLayer)
    layer2.setAll([
      ['0x1111111111111111111111111111111111111111111111111111111111111111_00', '0x00'],
      ['0xcd710b30bd2eab0352ddcc26417aa19463c716fb8fff3de61a883bb76adb34a2', '0x00'],
    ])

    expect(
      await layer2.getKeysPaged(
        '0xcd710b30bd2eab0352ddcc26417aa19463c716fb8fff3de61a883bb76adb34a2',
        1,
        '0xcd710b30bd2eab0352ddcc26417aa19463c716fb8fff3de61a883bb76adb34a2',
      ),
    ).toEqual([])

    const layer3 = new StorageLayer(layer2)
    layer3.setAll([['0x1111111111111111111111111111111111111111111111111111111111111111_01', '0x01']])

    expect(
      await layer3.getKeysPaged(
        '0xcd710b30bd2eab0352ddcc26417aa19463c716fb8fff3de61a883bb76adb34a2',
        1,
        '0xcd710b30bd2eab0352ddcc26417aa19463c716fb8fff3de61a883bb76adb34a2',
      ),
    ).toEqual([])
  })
})
